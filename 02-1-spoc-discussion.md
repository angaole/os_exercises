#lec 3 SPOC Discussion

## 第三讲 启动、中断、异常和系统调用-思考题

## 3.1 BIOS
 1. 比较UEFI和BIOS的区别。
 1. 描述PXE的大致启动流程。

1.UEFI具有很多BIOS不具备的功能：图形化界面、多种多样的操作方式、允许植入硬件驱动等，这些特性使UEFI相比于BIOS更加易用，更加方便，使硬件初始化以及引导系统变得简单快捷

2.PXE的大致启动过程：客户端个人电脑开机后，在TCP/IP Bootprom获得控制权之前先做自我测试；Bootprom送出BOOTP/DHCP要求以取得IP；如果服务器收到个人电脑所送出的要求，
就会送回BOOTP/DHCP回应；Bootprom由TFTP通讯协议从服务器下载开机映像文件；电脑通过这个开机映像文件开机。

## 3.2 系统启动流程
 1. 了解NTLDR的启动流程。
 1. 了解GRUB的启动流程。
 1. 比较NTLDR和GRUB的功能有差异。
 1. 了解u-boot的功能。
 
 1.NTLDR从引导扇区被装入并初始化;将处理器的实模式改为32位平滑内存模式;NTLDR开始运行适当的小文件系统驱动程序;NTLDR读boot.ini文件;NTLDR装载所选操作系统;如果windows NT/windows 2000/windows XP/windows server 2003这些操作系统被选择，NTLDR运行Ntdetect,如果对于其他的操作系统，NTLDR装载并运行Bootsect.dos然后向它传递控制；windows NT过程结束；Ntdetect搜索计算机硬件并将列表传送给NTLDR，以便将这些信息写进\\HKE Y_LOCAL_MACHINE\HARDWARE中；然后NTLDR装载Ntoskrnl.exe，Hal.dll和系统信息集合；Ntldr搜索系统信息集合，并装载设备驱动配置以便设备在启动时开始工作；Ntldr把控制权交给Ntoskrnl.exe，这时,启动程序结束,装载阶段开始

2.装载stagel；装载stagel.5；装载stagel2；读取boot/grub.conf文件并显示启动菜单；装载所选的kernel和initrd文件到内存中。

3.NTLDR是系统加载程序，具有隐藏和只读属性的系统文件，主要职责是解析Boot.int文件。
GRUB是多操作系统管理器，允许用户可以在计算机内同时安装有多个操作系统，比如不同版本的Windows和Linux，并在计算机启动时选择希望运行的操作系统。

4.系统引导支持NFS挂载、RAMDISK(压缩或非压缩)形式的根文件系统；支持NFS挂载、从FLASH中引导压缩或非压缩系统内核；基本辅助功能强大的操作系统接口功能；可灵活设置、传递多个关键参数给操作系统，适合系统在不同开发阶段的调试要求与产品发布，尤以Linux支持最为强劲；支持目标板环境参数多种存储方式，如FLASH、NVRAM、EEPROM；CRC32校验可校验FLASH中内核、RAMDISK镜像文件是否完好；设备驱动串口、SDRAM、FLASH、以太网、LCD、NVRAM、EEPROM、键盘、USB、PCMCIA、PCI、RTC等驱动支持；上电自检功能SDRAM、FLASH大小自动检测；SDRAM故障检测；CPU型号；特殊功能XIP内核引导。
 

## 3.3 中断、异常和系统调用比较
 1. 举例说明Linux中有哪些中断，哪些异常？
 1. Linux的系统调用有哪些？大致的功能分类有哪些？  (w2l1)

```
  + 采分点：说明了Linux的大致数量（上百个），说明了Linux系统调用的主要分类（文件操作，进程管理，内存管理等）
  - 答案没有涉及上述两个要点；（0分）
  - 答案对上述两个要点中的某一个要点进行了正确阐述（1分）
  - 答案对上述两个要点进行了正确阐述（2分）
  - 答案除了对上述两个要点都进行了正确阐述外，还进行了扩展和更丰富的说明（3分）
 ```
 
 1. 以ucore lab8的answer为例，uCore的系统调用有哪些？大致的功能分类有哪些？(w2l1)
 
 ```
  + 采分点：说明了ucore的大致数量（二十几个），说明了ucore系统调用的主要分类（文件操作，进程管理，内存管理等）
  - 答案没有涉及上述两个要点；（0分）
  - 答案对上述两个要点中的某一个要点进行了正确阐述（1分）
  - 答案对上述两个要点进行了正确阐述（2分）
  - 答案除了对上述两个要点都进行了正确阐述外，还进行了扩展和更丰富的说明（3分）
 ```
 
1. 中断 ：分为可屏蔽中断（Maskeble interrupt) 和非屏蔽的
  异常 ：故障（Fault) 如 缺页异常处理程序。
        陷阱（Trap) 当执行没有必要重新执行已终止的指令时，出发陷阱。
        异常终止（Abort) 用于报告严重的错误。
        编程异常 （Programmed exception)在编程者发出请求是发生。是由int 或(int3)指令时触。

2.linux 系统调用传统意义上有二百多个，但以C语言库函数的形式实现的系统调用更多，且因为Linux版本不同数量也会有差异，但基础的类型变化不大，比如write、read的文件读写操作；fork、clone等进程管理；getpriority等读取内核数据操作。从功能上分类，主要有：1）进程控制（fork，exit） 2）文件系统与文件操作（open，create，close） 3）内存管理（brk，sync） 4）系统控制（time, sysinfo) 5）网络管理(getdomainname,gethostname) 6）用户管理(getuid, setuid) 7）进程间通讯(ipc)。

3. ucore中系统调用大致有20多个。包括：文件操作，进程管理，内存管理, 系统控制。


 
 
## 3.4 linux系统调用分析
 1. 通过分析[lab1_ex0](https://github.com/chyyuu/ucore_lab/blob/master/related_info/lab1/lab1-ex0.md)了解Linux应用的系统调用编写和含义。(w2l1)
 
objdump可以查看目标文件或者可执行文件的各个段信息； nm用来列出目标文件的符号清单，例如 sys_fork, sys_close 等符号； file 即对文件操作；
输出“hello world”
>
>  设置系统调用编号  movl ($sys_write, %eax)
>
>  设置系统调用参数  
>
>  产生系统调用软中断命令 INT 0x80 
>
>  函数调用返回 ret


 ```
  + 采分点：说明了objdump，nm，file的大致用途，说明了系统调用的具体含义
  - 答案没有涉及上述两个要点；（0分）
  - 答案对上述两个要点中的某一个要点进行了正确阐述（1分）
  - 答案对上述两个要点进行了正确阐述（2分）
  - 答案除了对上述两个要点都进行了正确阐述外，还进行了扩展和更丰富的说明（3分）
 
 ```
 
 1. 通过调试[lab1_ex1](https://github.com/chyyuu/ucore_lab/blob/master/related_info/lab1/lab1-ex1.md)了解Linux应用的系统调用执行过程。(w2l1)
 
strace常用来跟踪进程执行时的系统调用和所接收的信号。在Linux中，进程不能直接访问硬件设备，当进程需要访问硬件设备(比如读取磁盘文件，接收网络数据)时，必须由用户态模式切换至内核态模式，通过系统调用访问硬件设备。strace可以跟踪到一个进程产生的系统调用,包括参数，返回值，执行消耗的时间，strace命令能够显示所有在程序中使用的系统调用。

>Linux应用的系统调用执行过程：
>用户程序------>C库（即API）：INT 0x80 ----->system_call------->系统调用服务例程-------->内核程序；
>系统调用是通过软中断指令 INT 0x80 实现的，而这条INT 0x80指令就被封装在C库的函数中。
>INT 0x80 这条指令的执行会让系统跳转到一个预设的内核空间地址，它指向系统调用处理程序，即system_call函数。

system_call函数找到具体的系统调用服务例程。系统调用服务例程只会从堆栈里获取参数，所以在system_call执行前，会先将参数存放在寄存器中，system_call执行时会首先将这些寄存器压入堆栈。system_call退出后，用户可以从寄存器中获得（被修改过的）参数。
 
当系统调用完成后，把控制权交回到发起调用的用户进程前，内核会有一次调度。如果发现有优先级更高的进程或当前进程的时间片用完，那么会选择优先级更高的进程或重新选择进程执行。


 ```
  + 采分点：说明了strace的大致用途，说明了系统调用的具体执行过程（包括应用，CPU硬件，操作系统的执行过程）
  - 答案没有涉及上述两个要点；（0分）
  - 答案对上述两个要点中的某一个要点进行了正确阐述（1分）
  - 答案对上述两个要点进行了正确阐述（2分）
  - 答案除了对上述两个要点都进行了正确阐述外，还进行了扩展和更丰富的说明（3分）
 ```
 
## 3.5 ucore系统调用分析
 1. ucore的系统调用中参数传递代码分析。
 1. ucore的系统调用中返回结果的传递代码分析。
 1. 以ucore lab8的answer为例，分析ucore 应用的系统调用编写和含义。
 1. 以ucore lab8的answer为例，尝试修改并运行代码，分析ucore应用的系统调用执行过程。
 
## 3.6 请分析函数调用和系统调用的区别
 1. 请从代码编写和执行过程来说明。
   1. 说明`int`、`iret`、`call`和`ret`的指令准确功能
 
